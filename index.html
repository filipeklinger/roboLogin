<!DOCTYPE html>
<head>
    <title>Daemon Conex達o</title>
    <meta charset="UTF-8">
    <script src="./jquery/jquery-3.4.1.min.js"></script>
    <script src="./momentjs/moment-with-locales.min.js"></script>
    <script src="./daemon.js"></script>
</head>
<body>
    <h1>N達o feche esta janela</h1>
    <p>Status da Conex達o: <span id="conexaoStatus"></span></p>
    <p>Ultima verificacao: <span id="ultimaVer"></span></p>
    <p>Ultima resposta: <span id="response"></span></p>
    <div id="log">
    </div>
    <p>Pagina de Login</p>
    <div id="paginaLogin"></div>
    
    <script>
        $(document).ready(()=>{
            verificaConectividade();
            umMinuto = 60000;
            setInterval(verificaConectividade, 5*umMinuto)
        })

        function verificaConectividade() {
            moment.locale('pt-br');
            $('#ultimaVer').empty().append(moment().format('D MMMM  YYYY, HH:mm:ss'))
            $('conexaoStatus').empty().append('<img src="./loader/blue.svg" width="20px"/>');
            url = 'https://api.openweathermap.org/data/2.5/weather?q=Seropedica&appid=31be04b6b19ed74e39655fd773ff1072&units=metric';
            ajaxLoadGET(url, parseResponse)
        }
        function parseResponse(response,status){
            determinaAcao(status);
            try{
                let json = JSON.parse(response);
                resposta = 
                'Local: '+json.name+
                '<br/>Temperatura: '+json.main.temp+
                '<br/>Minima: '+json.main.temp_min+
                '<br/>Maxima: '+json.main.temp_max
            }catch(e){
                resposta = e;
                console.log(json)
            }
            $('#response').empty().append( resposta );
            
        }

        function determinaAcao(status) {
            feedBack = $('#conexaoStatus')
            feedBack.empty().append((status == 200)? '200 Conectado': status+' Tentando Reconectar');
            if(status == 200){
                //n達o precisa de Login
            }else{
                loginProxy();
            }
        }

        function loginProxy() {
            host = 'http://10.0.0.103/ced';
            url = `${host}/portal/controle/login.php?req=processaLogin`;
            parametros = {login: 'master_adm',senha: '123'}
            $.post(url,parametros)
                .done((response)=>{
                    $('#paginaLogin').empty().append(response);
                    umSegundo = 1000;
                    setTimeout(verificaConectividade,30*umSegundo);
                });
        }
    </script>
</body>
</html>